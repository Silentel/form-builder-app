@let fields = fields$ | async;
@let fieldList = fields || [];

<div class="builder-container">
  <h2>–†–µ–∂–∏–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞</h2>

  <form [formGroup]="fieldForm" (ngSubmit)="onSubmit()" class="field-form">
    <div class="form-group">
      <label for="type">–¢–∏–ø –ø–æ–ª—è:</label>
      <select id="type" formControlName="type" class="form-control">
        @for (type of fieldTypes; track $index) {
          <option [value]="type">{{ type }}</option>
        }
      </select>
    </div>

    <div class="form-group">
      <label for="label">Label (–ü–æ–¥–ø–∏—Å—å):</label>
      <input id="label" type="text" formControlName="label" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å –ø–æ–ª—è">
      @if (f['label'].invalid && (f['label'].dirty || f['label'].touched)) {
        <div class="error">
          Label –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.
        </div>
      }
    </div>

    <div class="form-group">
      <label for="name">Name (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è):</label>
      <input id="name" type="text" formControlName="name" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è">
      @if (f['name'].invalid && (f['name'].dirty || f['name'].touched)) {
        <div class="error">
          Name –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.
        </div>
      }
    </div>

    <div class="form-group checkbox">
      <label for="required">
        <input id="required" type="checkbox" formControlName="required"> –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
      </label>
    </div>

    @if (fieldForm.get('type')?.value === 'select') {
      <div class="form-group">
        <label for="options">Options (–û–ø—Ü–∏–∏, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
        <input id="options" type="text" formControlName="options" class="form-control" placeholder="Option1, Option2, Option3">
      </div>
    }

    <button type="submit" class="btn btn-primary" [disabled]="fieldForm.invalid">
      {{ editingIndex !== null ? '–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ' : '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ' }}
    </button>
    @if (editingIndex !== null) {
      <button type="button" class="btn btn-secondary" (click)="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
    }
  </form>

  <div class="preview-section">
    <h3>–ü—Ä–µ–≤—å—é —Ñ–æ—Ä–º—ã:</h3>
    <div class="field-list">
      @for (field of fieldList; track field.name; let i = $index) {
        <div class="field-item" animate.enter="animate-in" animate.leave="animate-out">
          <div class="field-header">
            <strong>{{ field.label }}</strong> ({{ field.type }}) @if (field.required) {<span class="required-asterisk">*</span>}
            <div class="field-actions">
              <button (click)="editField(i)" class="btn-edit">‚úèÔ∏è</button>
              <button (click)="deleteField(i)" class="btn-delete">üóëÔ∏è</button>
            </div>
          </div>
          <div class="field-body">
            <small>Name: {{ field.name }}</small>
            @if (field.options) {
              <div><small>Options: {{ field.options.join(', ') }}</small></div>
            }
          </div>
        </div>
      }
      @if (fieldList.length === 0) {
        <div class="no-fields">
          –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ö –∑–¥–µ—Å—å.
        </div>
      }
    </div>
  </div>

  <div class="json-section">
    <h3>JSON-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</h3>
    <pre>{{ fieldList | json }}</pre>
  </div>
</div>
